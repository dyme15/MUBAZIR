<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Donatur - Mubazir</title>

    <link href="assets/img/extra/logo-M.png" rel="icon">

    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/css/donatur.css" rel="stylesheet">
</head>

<body>
    <div class="d-flex">
        <nav id="sidebar" class="d-flex flex-column p-3 vh-100 position-fixed">
            <img class="sidebar-logo" src="assets/img/extra/LOGO MUBAZIR-LOMBA (1).png" alt="Logo Mubazir">
            <div class="user-info">
            <h5 id="namaSidebar">Donatur Default</h5>
            <small id="donaturEmail">email@donatur.com</small>
            </div>
            <ul class="nav nav-pills flex-column mb-auto">
                <li><a class="nav-link active" data-section="dashboard"><i class="bi bi-speedometer2 me-2"></i> Dashboard</a></li>
                <li><a class="nav-link" data-section="buatDonasi"><i class="bi bi-plus-circle me-2"></i> Buat Donasi</a></li>
                <li><a class="nav-link" data-section="riwayat"><i class="bi bi-clock-history me-2"></i> Riwayat</a></li>
                <li><a class="nav-link" data-section="akun"><i class="bi bi-person-circle me-2"></i> Pengaturan Akun</a></li>
                <li><button id="logoutBtn" class="btn btn-outline-light mt-3 w-100"><i class="bi bi-box-arrow-right"></i> Logout</button></li>
            </ul>
        </nav>

        <div id="content" class="flex-grow-1">
            <nav class="navbar navbar-light shadow-sm">
                <div class="container-fluid d-flex align-items-center">
                    <button id="toggleSidebar" class="btn btn-outline-success me-3"><i class="bi bi-grid"></i></button>
                    <span class="ms-auto badge custom-green fs-6 shadow-sm"><i class="bi bi-people"></i> Donatur Mode</span>
                </div>
            </nav>

            <div class="container my-4">
                <div id="dashboard" class="page-section active">
                    <div class="card p-4 mb-4">
                        <h3>Selamat Datang, <span id="namaDashboard">Donatur!</span></h3>
                        <p class="text-muted">Berikut progres Anda berdasarkan 6 kriteria utama 🌱</p>
                        <div class="row g-4 mt-2" id="dashboardCards">
                        </div>
                    </div>
                </div>

                <div id="buatDonasi" class="page-section">
                    <div class="card p-4">
                        <h4>Buat Donasi Baru</h4>
                        <form id="formDonasi" class="row g-3 mt-2">
                            <div class="col-md-12">
                                <label class="form-label">Kategori Donasi</label>
                                <select id="kategoriDonasi" class="form-select" required>
                                    <option value="" disabled selected>-- Pilih Kategori --</option>
                                    <option value="makanan">Makanan</option>
                                    <option value="snack">Snack & Roti</option>
                                    <option value="minuman">Minuman</option>
                                    <option value="buah">Buah & Hidangan Penutup</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Nama Donasi</label>
                                <input id="namaDonasi" type="text" class="form-control" placeholder="Contoh: Nasi Kotak 5 porsi" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Jumlah</label>
                                <input id="jumlahDonasi" type="number" class="form-control" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Satuan</label>
                                <select id="satuanDonasi" class="form-select">
                                    <option>Porsi</option>
                                    <option>Buah</option>
                                    <option>Botol</option>
                                </select>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Masa Kadaluarsa/Kualitas Makanan</label>
                                <input id="masaKadaluarsa" type="text" class="form-control" 
                                    placeholder="Contoh: Baik hingga 5 jam ke depan / Exp. 2025-12-31" required>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Lokasi Penjemputan</label>
                                <input id="lokasi" type="text" class="form-control mb-2" 
                                    placeholder="Masukkan alamat penjemputan donasi (Misal: Jl. Utama No. 12, Medan)" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Upload Foto</label>
                                <input type="file" class="form-control" id="fotoDonasi">
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-success">Buat Donasi</button>
                            </div>
                        </form>
                    </div>

                    <div id="hasilDonasi" class="card p-4 mt-4 d-none">
                        <div class="alert alert-success text-center" role="alert">
                            <h5 class="alert-heading">✅ Donasi Berhasil Diunggah!</h5>
                            <p>Terima kasih telah mengupload. Donasi akan ditinjau terlebih dahulu oleh admin dalam waktu singkat.</p>
                            <hr>
                            <p class="mb-0 small">Mohon pastikan makanan dalam kondisi siap dikonsumsi.</p>
                        </div>
                        <h5>Detail Donasi Anda:</h5>
                        <p><strong>Kategori:</strong> <span id="hasilKategori"></span></p>
                        <p><strong>Nama Donasi:</strong> <span id="hasilNama"></span></p>
                        <p><strong>Jumlah:</strong> <span id="hasilJumlah"></span></p>
                        <p><strong>Kadaluarsa:</strong> <span id="hasilKadaluarsa"></span></p>
                        <p><strong>Lokasi:</strong> <span id="hasilLokasi"></span></p>
                        
                        <button id="scanBtn" class="btn btn-outline-primary mt-2"><i class="bi bi-upload"></i> Unggah Kode Penyalur</button>
                        
                        <input type="file" id="qrFileInput" accept=".txt, .json, .png" style="display: none;">
                        
                        <div id="scanResult" class="mt-3 alert alert-info d-none">Unggah file untuk simulasi kode QR penyalur.</div>
                    </div>
                </div>

                <div id="riwayat" class="page-section">
                    <div class="card p-4">
                        <h4>Riwayat Donasi Saya</h4>
                        <table class="table table-hover mt-3">
                            <thead>
                                <tr>
                                    <th>Nama Donasi</th>
                                    <th>Jumlah</th>
                                    <th>Lokasi</th>
                                    <th>Status</th>
                                    <th>Bukti Terima</th>
                                </tr>
                            </thead>
                            <tbody id="riwayatTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="akun" class="page-section">
                    <div class="card p-4">
                        <h4>Pengaturan Akun</h4>
                        <form id="formAkun">
                        <!-- Tidak bisa diganti -->
                        <div class="mb-3">
                            <label for="namaDonatur" class="form-label">Nama</label>
                            <input type="text" class="form-control" id="namaDonatur" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="emailDonatur" class="form-label">Email</label>
                            <input type="email" class="form-control" id="emailDonatur" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="noHpDonatur" class="form-label">No HP</label>
                            <input type="text" class="form-control" id="noHpDonatur" readonly>
                        </div>

                        <!-- Bisa diganti -->
                        <div class="mb-3">
                            <label for="passwordBaru" class="form-label">Password Baru</label>
                            <input type="password" class="form-control" id="passwordBaru" placeholder="Kosongkan jika tidak ganti">
                        </div>

                        <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                    </form>

                    </div>
                </div>

            </div>
        </div>
    </div>
    
    <div class="modal fade" id="buktiTerimaModal" tabindex="-1" aria-labelledby="buktiTerimaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="buktiTerimaModalLabel">Bukti Terima Donasi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalBuktiImage" src="" class="img-fluid rounded" alt="Bukti Terima" style="max-height: 80vh;">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>


    <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script type="module" src="assets/js/donatur.js"></script>
    <script type="module">
        import {
            tambahDonasi,
            listenDonasiByDonaturId
        } from "./assets/js/database.js";

        document.addEventListener("DOMContentLoaded", () => {

            // =====================
            // Proteksi Donatur
            // =====================
            const user = JSON.parse(localStorage.getItem("user"));
            if (!user || user.role !== "donatur") {
                window.location.replace("login.html");
                return;
            }
            const userId = user.id;

            // =====================
            // Set Info User di Sidebar & Dashboard
            // =====================
            const namaSidebarEl = document.getElementById("namaSidebar");
            const namaDashboardEl = document.getElementById("namaDashboard");
            const usernameSidebarEl = document.getElementById("donaturEmail");
            const profilePicEl = document.getElementById("profilePic");

            namaSidebarEl.textContent = user.nama;
            namaDashboardEl.textContent = user.nama;
            usernameSidebarEl.textContent = "@" + (user.email.split("@")[0] || "donatur");

            // =====================
            // Logout
            // =====================
            const logoutBtn = document.getElementById("logoutBtn");
            if (logoutBtn) {
                logoutBtn.addEventListener("click", () => {
                    localStorage.removeItem("user");
                    window.location.href = "login.html";
                });
            }

            // =====================
            // Sidebar Toggle
            // =====================
            const toggleSidebar = document.getElementById("toggleSidebar");
            if (toggleSidebar) {
                toggleSidebar.addEventListener("click", () => {
                    document.getElementById("sidebar").classList.toggle("collapsed");
                    document.getElementById("content").classList.toggle("expanded");
                });
            }

            // =====================
            // Navigasi Sidebar
            // =====================
            document.querySelectorAll("#sidebar .nav-link").forEach((link) => {
                link.addEventListener("click", () => {
                    document.querySelectorAll("#sidebar .nav-link").forEach((l) => l.classList.remove("active"));
                    document.querySelectorAll(".page-section").forEach((sec) => sec.classList.remove("active"));
                    link.classList.add("active");
                    const sectionId = link.getAttribute("data-section");
                    if (sectionId) document.getElementById(sectionId).classList.add("active");
                });
            });

            // =====================
            // Form Donasi
            // =====================
            const formDonasi = document.getElementById("formDonasi");
            if (formDonasi) {
                formDonasi.addEventListener("submit", async (e) => {
                    e.preventDefault();

                    const kategori = document.getElementById("kategoriDonasi").value;
                    const namaDonasi = document.getElementById("namaDonasi").value;
                    const jumlah = document.getElementById("jumlahDonasi").value;
                    const satuan = document.getElementById("satuanDonasi").value;
                    const masaKadaluarsa = document.getElementById("masaKadaluarsa").value;
                    const lokasi = document.getElementById("lokasi").value;
                    const fotoInput = document.getElementById("fotoDonasi");

                    let fotoBase64 = "";
                    if (fotoInput?.files && fotoInput.files[0]) {
                        const reader = new FileReader();
                        reader.onload = async (ev) => {
                            fotoBase64 = ev.target.result;
                            await simpanDonasi();
                        };
                        reader.readAsDataURL(fotoInput.files[0]);
                    } else {
                        await simpanDonasi();
                    }

                    async function simpanDonasi() {
                        try {
                            const data = {
                                kategori,
                                nama: namaDonasi,
                                jumlah,
                                satuan,
                                masaKadaluarsa,
                                lokasi,
                                status: "Tersedia",
                                donaturId: user.id,
                                foto: fotoBase64
                            };
                            const donasiId = await tambahDonasi(data);

                            // Update Hasil Donasi Display
                            document.getElementById("hasilKategori").textContent = kategori;
                            document.getElementById("hasilNama").textContent = namaDonasi;
                            document.getElementById("hasilJumlah").textContent = jumlah + " " + satuan;
                            document.getElementById("hasilKadaluarsa").textContent = masaKadaluarsa;
                            document.getElementById("hasilLokasi").textContent = lokasi;
                            
                            // Reset scan result state
                            document.getElementById("scanResult").classList.add("d-none");

                            formDonasi.classList.add("d-none");
                            document.getElementById("hasilDonasi").classList.remove("d-none");
                            console.log("✅ Donasi tersimpan:", donasiId);
                        } catch (err) {
                            console.error(err);
                            alert("Gagal menyimpan donasi. Coba lagi.");
                        }
                    }
                });
            }

            // =====================
            // QR SCANNER SIMULATION (UPLOAD FILE)
            // =====================
            const scanBtn = document.getElementById("scanBtn");
            const qrFileInput = document.getElementById("qrFileInput");
            const scanResultEl = document.getElementById("scanResult");

            if (scanBtn && qrFileInput) {
                scanBtn.addEventListener("click", () => {
                    scanResultEl.classList.add("d-none");
                    qrFileInput.click();
                });

                qrFileInput.addEventListener("change", (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const simulatedCode = `CODE-${file.name.substring(0, 10)}`; 

                        scanResultEl.classList.remove("d-none", "alert-info", "alert-danger");
                        scanResultEl.classList.add("alert-success");
                        scanResultEl.innerHTML = `<i class="bi bi-check-circle-fill"></i> Kode berhasil diunggah! Kode: <strong>${simulatedCode}</strong>.`;

                        console.log(`Simulasi Kode Penyalur Terunggah: ${simulatedCode}`);
                    } else {
                        scanResultEl.classList.remove("d-none", "alert-success", "alert-danger");
                        scanResultEl.classList.add("alert-info");
                        scanResultEl.textContent = "Unggahan dibatalkan.";
                    }
                });
            }

            // =====================
            // Profil Update
            // =====================
            const formAkun = document.getElementById("formAkun");
            if (formAkun) {
                formAkun.addEventListener("submit", (e) => {
                    e.preventDefault();
                    const nama = document.getElementById("namaDonatur").value || "Donatur Default";
                    namaSidebarEl.textContent = nama;
                    namaDashboardEl.textContent = nama;

                    const fotoInput = document.getElementById("fotoProfil");
                    if (fotoInput?.files && fotoInput.files[0]) {
                        const reader = new FileReader();
                        reader.onload = (ev) => profilePicEl.src = ev.target.result;
                        reader.readAsDataURL(fotoInput.files[0]);
                    }
                });
            }

            // =====================
            // Riwayat Donasi Realtime
            // =====================
            const tbody = document.getElementById("riwayatTableBody");
            if (tbody) {
                tbody.innerHTML = "<tr><td colspan='5'>⏳ Memuat...</td></tr>";

                if (userId) {
                    listenDonasiByDonaturId(userId, (data) => {
                        tbody.innerHTML = "";

                        if (!data || data.length === 0) {
                            tbody.innerHTML = "<tr><td colspan='5'>Belum ada donasi dari Anda.</td></tr>";
                            return;
                        }

                        data.forEach((donasi) => {
                            const tr = document.createElement("tr");

                            if (donasi.donaturId === userId) {
                                let buktiTerimaContent = '-';
                                const buktiFotoUrl = donasi.buktiTerimaFoto || donasi.ulasan; 
                                
                                if (buktiFotoUrl) {
                                    buktiTerimaContent = `
                                        <button class="btn btn-sm btn-info" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#buktiTerimaModal"
                                            data-foto-url="${buktiFotoUrl}">
                                            <i class="bi bi-image"></i> Lihat Bukti
                                        </button>
                                    `;
                                } else if (donasi.status === "diambil") {
                                    buktiTerimaContent = `<span class="text-muted">Menunggu</span>`;
                                }
                                
                                tr.innerHTML = `
                                    <td>${donasi.nama || "-"}</td>
                                    <td>${donasi.jumlah || 0} ${donasi.satuan || ""}</td>
                                    <td>${donasi.lokasi || "-"}</td>
                                    <td>
                                        <span class="badge ${donasi.status === "diambil" ? "bg-success" : "bg-warning"}">
                                            ${donasi.status || "Tersedia"}
                                        </span>
                                    </td>
                                    <td>${buktiTerimaContent}</td>
                                `;
                                tbody.appendChild(tr);
                            }
                        });
                        
                        const modal = document.getElementById('buktiTerimaModal');
                        if (modal) {
                            modal.addEventListener('show.bs.modal', function (event) {
                                const button = event.relatedTarget;
                                const fotoUrl = button.getAttribute('data-foto-url');
                                const modalImage = document.getElementById('modalBuktiImage');
                                modalImage.src = fotoUrl;
                            });
                        }
                        
                    });
                } else {
                    tbody.innerHTML = "<tr><td colspan='5'>Error: ID Donatur tidak ditemukan.</td></tr>";
                }
            }

        });
    </script>

</body>

</html>
